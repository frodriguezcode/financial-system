
<div style="margin-top: -10px;">
  <button type="button" (click)="crearCuenta()" class="btn btn-success mb-4 shadow-4 m-1" ngbTooltip="Click para crear registro"
    >Cuenta Bancaria <i class="fa-solid fa-plus"></i
  ></button>
  <button type="button" (click)="crearElemento()" class="btn btn-success mb-4 shadow-4 m-1" ngbTooltip="Click para crear registro"
    >Centro de Costo <i class="fa-solid fa-plus"></i
  ></button>
  <button type="button" (click)="crearSocioNegocio()" class="btn btn-success mb-4 shadow-4 m-1" ngbTooltip="Click para crear registro"
    >Socio de Negocio <i class="fa-solid fa-plus"></i
  ></button>

</div>

<div class="d-flex justify-content-center">

  <button type="button" (click)="switchTipoRegistro(1)" class="btn btn-info m-1">General <i class="fa-solid fa-building"></i></button>
  <button type="button" (click)="switchTipoRegistro(2)" class="btn btn-warning m-1">Proyectos <i class="fa-solid fa-diagram-project"></i></button>
</div>
<div *ngIf="cargando==true" class="text-center">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
<br>
  <p-table
    #dt1
    [value]="Registros"
    [paginator]="true"
    [rows]="10"
    [scrollable]="true"
    [(selection)]="registrosSeleccionados" 
    dataKey="id" 
    [showCurrentPageReport]="true"
    [tableStyle]="{ 'min-width': '50rem' }"
    [globalFilterFields]="['AnioRegistro', 'FechaRegistro', 'MesRegistro', 'Semana', 'NombreElemento','NumCuenta','CategoriaNombre','SocioNegocio']"
    currentPageReportTemplate="Mostrando del {first} al {last} de {totalRecords} registros"
    [rowsPerPageOptions]="[10, 10, 20]" 
    
  >


    <ng-template pTemplate="caption" >
      <div class="row">
        <div class="col-4">
          <p-iconField iconPosition="left">
            <label for="formGroupExampleInput" class="form-label">Buscar por cualquier campo</label>

            <!-- <p-inputIcon *ngIf="inputVal.length < 10" styleClass="pi pi-search" /> -->
            <input
              style="width: 16rem; text-align:center"
              pInputText
              type="text"
              class="form-control"
              autocomplete="off"
              (input)="dt1.filterGlobal($any($event.target).value, 'contains')"
              id="exampleInputEmail1"
              aria-describedby="emailHelp"
              [(ngModel)]="inputVal" 
              placeholder="Buscar..."
            />
          </p-iconField>
        </div>
        <div *ngIf="idTipoRegistro==1" class="col-4">
          <label for="formGroupExampleInput" class="form-label">Buscar por sucursal</label>
          <br>
          <p-dropdown 
          (onChange)="filtrarByCategoria()"
          [options]="Sucursales" 
          [(ngModel)]="SucursaleSeleccionada" 
          optionLabel="Nombre" 
          placeholder="Seleccione una sucursal" />
        </div>
        <div  *ngIf="idTipoRegistro==2" class="col-4">
          <label for="formGroupExampleInput" class="form-label">Buscar por proyecto</label>
          <br>
          <p-dropdown 
          (onChange)="filtrarByCategoria()"
          [options]="Proyectos" 
          [(ngModel)]="ProyectoSeleccionado" 
          optionLabel="NombreSucursal" 
          placeholder="Seleccione un proyecto" />
        </div>
        <div   class="col-4">
          <label for="formGroupExampleInput" class="form-label">Buscar por categoría</label>
          <br>
          <p-multiSelect 
          (onChange)="filtrarByCategoria()"
          [options]="Categorias" 
          [(ngModel)]="CategoriasSeleccionadas" 
          optionLabel="Nombre" 
          placeholder="Seleccione una categoria" />
        </div>




        <div class="col-2">

          <div class="mb-3">
            <label for="formGroupExampleInput" class="form-label">Fecha Inicio</label>
            <input type="date"[formControl]="FechaDesde" class="form-control" id="formGroupExampleInput" placeholder="Example input placeholder">
          </div>

        </div>
        <div class="col-2">

          <div class="mb-3">
            <label for="formGroupExampleInput" class="form-label">Fecha Final</label>
            <input type="date" [formControl]="FechaHasta" class="form-control" id="formGroupExampleInput" placeholder="Example input placeholder">
          </div>

        </div>
 

        <br>
        <!-- <div class="col-2">

          <button type="button" (click)="buscarByFecha()" class="btn btn-success mb-4 shadow-4 mt-4" ngbTooltip="Click para buscar"
          >Buscar </button>

        </div>
        <div class="col-2">

          <button type="button" (click)="restablecer()" class="btn btn-info mb-4 shadow-4 mt-4" ngbTooltip="Click para buscar"
          >Restablecer </button>

        </div> -->
  
      </div>
      <div class="row justify-content-start">
        <div class="col-auto">
        <button type="button" class="btn btn-success  shadow-4 mx-auto"
        (click)="buscarByFecha()"
        [disabled]="(this.FechaDesde.value=='' || this.FechaHasta.value=='' )"
        >Buscar <i class="fa-solid fa-magnifying-glass"></i>
      </button>
        </div>
        <div class="col-auto">
       <button type="button" class="btn btn-primary shadow-4 mx-auto" (click)="restablecer()">Limpiar filtros <i class="fa-solid fa-rotate-right"></i></button>
        </div>
        <div class="col-auto">
            <button type="button" (click)="crearRegistro(1)" class="btn btn-info shadow-4 mx-auto" ngbTooltip="Crear ingreso">Ingreso <i class="fa-solid fa-plus"></i></button>
        </div>
        <div class="col-auto">
            <button type="button" (click)="crearRegistro(2)" class="btn btn-danger shadow-4 mx-auto" ngbTooltip="Crear egreso">Egreso <i class="fa-solid fa-minus"></i ></button>
        </div>
        <div class="col-auto">
            <button type="button"
            [disabled]="this.registrosSeleccionados.length==0"
            (click)="borrarRegistros()" class="btn btn-success shadow-4 mx-auto" ngbTooltip="Borrar">Borrar Registro
               <i class="fa-solid fa-trash"></i ></button>
        </div>
        <div class="col-auto">
            <button type="button"
            [disabled]="this.Registros.length==0"
            (click)="descargarRegistros()" class="btn btn-primary shadow-4 mx-auto" ngbTooltip="Descargar Registros">Exportar
            <i class="fa-solid fa-file-excel"></i></button>
        </div>

 
    </div>
    


    </ng-template>

    <ng-template pTemplate="header">
      <tr class="text-center">
        <th style="width: 4rem"><p-tableHeaderCheckbox /></th>
        <th style="text-transform: uppercase;font-size: 13px;">Copiar</th>
        <th style="text-transform: uppercase;font-size: 13px;">Registro</th>
        <th style="text-transform: uppercase;font-size: 13px;">Fecha</th>
        <th style="text-transform: uppercase;font-size: 13px;">Categoría</th>
        <th style="text-transform: uppercase;font-size: 13px;">Cuenta Contable</th>
        <th style="text-transform: uppercase;font-size: 13px;">Cuenta Bancaria <span style="color: #0c8c86;font-weight: bold;">(opcional)</span></th>
        <th *ngIf="this.idTipoRegistro==1" style="text-transform: uppercase;font-size: 13px;">Sucursal <span style="color: #0c8c86;font-weight: bold;">(opcional)</span></th>
        <th *ngIf="this.idTipoRegistro==2" style="text-transform: uppercase;font-size: 13px;">Proyecto <span style="color: #0c8c86;font-weight: bold;">(opcional)</span></th>
        <th style="text-transform: uppercase;font-size: 13px;">Importe</th>
        <th style="text-transform: uppercase;font-size: 13px;">Flujo</th>
        <th style="text-transform: uppercase;font-size: 13px;">Socio Negocios <span style="color: #0c8c86;font-weight: bold;">(opcional)</span></th>
        <th style="text-transform: uppercase;font-size: 13px;">Comentarios <span style="color: #0c8c86;font-weight: bold;">(opcional)</span></th>
        <th style="text-transform: uppercase;font-size: 13px;">Guardar</th>
      </tr>
    </ng-template>
 

    <ng-template pTemplate="body" let-registros let-index="index">
   
      <tr  *ngIf="cargando==false"   [ngClass]="{'Egreso': registros.idTipo === 2, 'Ingreso' : registros.idTipo === 1 }">
        
        <!-- Elementos -->
        <td>
          <p-tableCheckbox [value]="registros" />
      </td>
        <td class="text-center">
          <ng-container>
            <button type="button" (click)="copiarRegistro(registros)" 
           
            [ngClass]="registros.idTipo==1 ? 'btn btn-info':'btn btn-danger'" 
            >
            
            <i class="fa-solid fa-copy"></i></button>
          </ng-container>
        </td>
        <td class="text-center">
          <ng-container>
            {{ registros.Orden }}
          </ng-container>
        </td>
        <td class="text-center">
          <input style="min-height: 3rem" type="date" [(ngModel)]="registros.FechaRegistro" class="form-control text-center col-4" />
        </td>
   
        <td class="text-center" >
   
          <p-dropdown
          [options]="this.getCategoriasByTipo(registros.idTipo)"
          [(ngModel)]="registros.idCategoria"
          name="ItemSeleccionados"
          optionLabel="Nombre"
          [filter]="true"
          filterBy="Nombre"
          [showClear]="false"
          placeholder="Seleccione una Categoría"
          appendTo="body"
        >
          <ng-template pTemplate="selectedItem" let-selectedItem>
            <div class="flex align-items-lg-start gap-2">
              <div class="seleccion-item">{{ selectedItem.Nombre }}</div>
            </div>
          </ng-template>
        </p-dropdown>
        </td>
        <td class="text-center" >
          <p *ngIf="this.Items.length==0" 
          class="animate__animated animate__bounceIn"
          style="color: red; font-size: 10px;">
          No tienes cuentas asociadas a este proyecto
          </p>
          <p *ngIf="getCuentabyCategoria(registros.idCategoria).length==0 && registros.idCategoria!=''" 
          class="animate__animated animate__bounceIn"
          style="color: red; font-size: 10px;">
          No tienes cuentas asociadas a esta categoría
          </p>
          <p-dropdown
          [options]="getCuentabyCategoria(registros.idCategoria)"
          [(ngModel)]="registros.NombreElemento"
          name="registros.Elemento"
          optionLabel="label"
          optionValue="label"
          [filter]="true"
          filterBy="label"
          [disabled]="this.Items.length==0 || registros.idCategoria=='' || getCuentabyCategoria(registros.idCategoria).length==0"
          [showClear]="false"
          placeholder="Seleccione una cuenta"
          appendTo="body"
        >
          <ng-template pTemplate="selectedItem" let-selectedItem>
            <div class="flex align-items-lg-start gap-2">
              <div class="seleccion-item">{{ selectedItem.label }}</div>
            </div>
          </ng-template>
        </p-dropdown>
        </td>

        <td class="text-center">
          <p-dropdown
            [options]="cuentas"
            [(ngModel)]="registros.Cuenta"
            name="ItemSeleccionados"
            optionLabel="Cuenta"
            [filter]="true"
            filterBy="Cuenta"
            [showClear]="false"
            placeholder="Seleccione una cuenta"
            appendTo="body"
          >
            <ng-template pTemplate="selectedItem" let-selectedItem>
              <div class="flex align-items-lg-start gap-2">
                <div class="seleccion-item">{{ selectedItem.Cuenta  }}</div>
              </div>
            </ng-template>
          </p-dropdown>
        </td>

        <td *ngIf="registros.TipoRegistro==1" class="text-center">
          <p-dropdown
          [options]="Sucursales"
          [(ngModel)]="registros.Sucursal"
          name="SucursalesSeleccionadas"
          optionLabel="Nombre"
          optionValue="Nombre"
          [filter]="true"
          filterBy="Sucursal"
          [showClear]="false"
          placeholder="Seleccione una sucursal"
          appendTo="body">
          <ng-template pTemplate="selectedItem" let-selectedItem>
            <div class="flex align-items-lg-start gap-2">
              <div class="seleccion-item">{{ selectedItem.Nombre }}</div>
            </div>
          </ng-template>
        </p-dropdown>
        
        </td>
        <td *ngIf="registros.TipoRegistro==2" class="text-center">
          <p-dropdown
          [options]="Proyectos"
          [(ngModel)]="registros.Proyecto"
          name="ProyectosSeleccionados"
          optionLabel="NombreSucursal"
          optionValue="NombreSucursal"
          [filter]="true"
          filterBy="NombreSucursal"
          [showClear]="false"
          placeholder="Seleccione un proyecto"
          appendTo="body">
          <ng-template pTemplate="selectedItem" let-selectedItem>
            <div class="flex align-items-lg-start gap-2">
              <div class="seleccion-item">{{ selectedItem.NombreSucursal }}</div>
            </div>
          </ng-template>
        </p-dropdown>
        
        </td>


        <td class="text-center">
          <div class="animate__animated animate__bounceIn custom-alert shadow-1" 
          style="color: red; font-size: 11px;" 
          *ngIf="validarEgreso(registros.idTipo,registros.Valor,registros.Orden)==false">El valor debe ser negativo
        </div>
              <input
              [ngClass]="registros.idTipo == 1 ? 'textoInputPositivo' : 'textoInputNegativo'"
              (keyup.enter)="salvarRegistro(registros,Valor.value)"
              #Valor
              [disabled]="this.Items.length==0 || registros.idCategoria=='' || getCuentabyCategoria(registros.idCategoria).length==0"
              (input)="validarEgreso(registros.idTipo,registros.Valor,registros.Orden);onInput($event)"
              style="min-width: 9rem; min-height: 1rem; font-weight: bolder"
              [ngModel]="registros.Valor | currencySymbol"
              class="form-control text-center col-6"/>
       
        
       
        </td>

        <td class="text-center">
          <p-dropdown
            [options]="Flujos"
            [(ngModel)]="registros.idFlujo"
            name="flujos"
            optionLabel="name"
            [filter]="true"
            filterBy="name"
            [showClear]="false"
            placeholder="Seleccione un flujo"
            appendTo="body"
          >
            <ng-template pTemplate="selectedItem" let-selectedItem>
              <div class="flex align-items-center gap-2">
                <div class="seleccion-item" style="min-width: 9rem">{{ selectedItem.name }}</div>
              </div>
            </ng-template>
          </p-dropdown>
        </td>
        <td class="text-center">
          <p-dropdown
            [options]="SociosNegocios"
            [(ngModel)]="registros.idSocioNegocio"
            name="SociosNegocios"
            optionLabel="Nombre"
            [filter]="true"
            filterBy="Nombre"
            [showClear]="false"
            placeholder="Seleccione un socio de negocios"
            appendTo="body"
          >
            <ng-template pTemplate="selectedItem" let-selectedItem>
              <div class="flex align-items-lg-start gap-2">
                <div class="seleccion-item">{{ selectedItem.Nombre }}</div>
              </div>
            </ng-template>
          </p-dropdown>
        </td>
        <td class="text-center">
              <input
              (keyup.enter)="salvarRegistro(registros,Valor.value)"
              [disabled]="this.Items.length==0 || registros.idCategoria=='' || getCuentabyCategoria(registros.idCategoria).length==0"
              style="min-width: 9rem; min-height: 1rem; font-weight: bolder"
              [(ngModel)]="registros.Comentarios "
              class="form-control text-center col-6"/>
        </td>

       
        <td class="text-center">
          <button type="button" [disabled]="isNegativo==false || this.Items.length==0 || registros.idCategoria=='' || getCuentabyCategoria(registros.idCategoria).length==0" (click)="salvarRegistro(registros,Valor.value)" class="btn btn-success" ngbTooltip="Guardar registro"
            ><i class="fa-solid fa-floppy-disk"></i
          ></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
  <p style="text-transform: uppercase;font-size: 13px; font-weight: bold; color: red;"
  *ngIf="ImporteSubTotal<0">
  Importe Sub-Total: <strong>{{ " -$ " + (ImporteSubTotal*-1 | number)}}</strong>
  </p>
  <p style="text-transform: uppercase;font-size: 13px; font-weight: bold;"
  *ngIf="ImporteSubTotal>=0">
  Importe Sub-Total: <strong>{{ " $ " + (ImporteSubTotal| number)}}</strong> 
  </p>

  <p style="text-transform: uppercase;font-size: 13px; font-weight: bold; color: red;"
  *ngIf="ImporteTotal<0">
  Importe Total: <strong>{{ " -$ " + (ImporteTotal*-1 | number)}}</strong> 
  </p>
  <p style="text-transform: uppercase;font-size: 13px; font-weight: bold;"
  *ngIf="ImporteTotal>=0">
  Importe Total: <strong>{{ " $ " + (ImporteTotal| number)}}</strong> 
  </p>



<p-dialog
  header=""
  [(visible)]="visibleCuenta"
  [modal]="true"
  [style]="{ width: '75vw', height: '70vh' }"
  [modal]="true"
  styleClass="p-fluid"
  [draggable]="false"
  [resizable]="false"
>
<app-bancos  *ngIf="visibleCuenta==true"></app-bancos>
</p-dialog>
<p-dialog
  header="Agregar Item"
  [(visible)]="visibleElemento"
  [modal]="true"
  [style]="{ width: '75vw', height: '90vh' }"
  [modal]="true"
  styleClass="p-fluid"
  [draggable]="false"
  [resizable]="true"
  [maximizable]="true"
>
<app-elemento *ngIf="visibleElemento==true"></app-elemento>
</p-dialog>
<p-dialog
  header="Agregar Socio de Negocio"
  [(visible)]="visibleSocioNegocio"
  [modal]="true"
  [style]="{ width: '75vw', height: '70vh' }"
  [modal]="true"
  styleClass="p-fluid"
  [draggable]="false"
  [resizable]="false"
  [maximizable]="true"
>
<app-socios *ngIf="visibleSocioNegocio==true"></app-socios>
</p-dialog>

<!-- *EDITAR REGISTRO -->

<!-- Nuevo -->

<!-- <p-button label="Crear Registro" [rounded]="true" [raised]="true" severity="success" (click)="addRow()" ></p-button>
   
    <div class="card w-full mt-3 border-500 hover:border-40 border p-2 ">
    
      
    
        <p-toast></p-toast>
        <p-table class=" mb-2 mt-3" [value]="_Registros" dataKey="id" editMode="row" [tableStyle]="{'min-width': '50rem'}">
            <ng-template pTemplate="header" >
                <tr >
                    <th class="bg-green-50">Flujo</th>

                    <th class="bg-green-50" >Operacion</th>
                    <th class="bg-green-50" >Categoria</th>
                    <th class="bg-green-50" >Cuenta Banco</th>
                    <th class="bg-green-50" >Valor</th>
                    <th class="bg-green-50" >Fecha</th>
                    <th class="bg-green-50" >Socio de negocio</th>
                    <th class="bg-green-50"></th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-_Registro let-editing="editing" let-ri="rowIndex">
                <tr  [pEditableRow]="_Registro">
                    <td class="border-bottom-1 border-200">
                        <p-cellEditor>
                            <ng-template  pTemplate="input">
                                <p-dropdown
                                 [options]="Flujos" name="ItemSeleccionados" 
                                appendTo="body" [(ngModel)]="_Registro.idFlujo.name" [filter]="true" [showClear]="false" optionLabel="name"
                                filterBy="name" [style]="{'width':'100%'}"
                                placeholder="Tipo de flujo">
                                <ng-template   pTemplate="selectedItem" let-selectedItem>
                                    {{selectedItem.name}}
                                </ng-template>
                            </p-dropdown>
                             </ng-template>
                            <ng-template    pTemplate="output">
                                    {{_Registro.idFlujo}}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                
                    <td class="border-bottom-1 border-200">
                        <p-cellEditor>
                            <ng-template  pTemplate="input">
                                <p-dropdown
                                 [options]="Items" name="ItemSeleccionados"
                                appendTo="body" [(ngModel)]="_Registro.Elemento.Nombre" [filter]="true" [showClear]="false" optionLabel="Nombre"
                                filterBy="Nombre" [style]="{'width':'100%'}"
                                placeholder="Seleccione una categoría">
                                <ng-template  pTemplate="selectedItem" let-selectedItem>
                                    {{selectedItem.Nombre}}
                                </ng-template>
                            </p-dropdown>
                             </ng-template>
                            <ng-template  pTemplate="output">
                                    {{_Registro.Elemento.Nombre}}
                                    
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td class="border-bottom-1 border-200">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <p-dropdown
                                 [options]="Categorias" name="ItemSeleccionados"
                                appendTo="body" [(ngModel)]="_Registro.idCategoria" [filter]="true" [showClear]="false" optionLabel="Nombre"
                                filterBy="Nombre" [style]="{'width':'100%'}"
                                placeholder="Seleccione una categoría">
                                <ng-template   pTemplate="selectedItem" let-selectedItem>
                                    {{selectedItem.Nombre}}
                                </ng-template>
                            </p-dropdown>
                             </ng-template>
                            <ng-template   pTemplate="output">
                                    {{_Registro.idCategoria.Nombre}}
                                    
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td class="border-bottom-1 border-200">
                      <p-cellEditor>
                          <ng-template pTemplate="input">
                              <input pInputText type="text" [(ngModel)]="_Registro.Cuenta" required>
                          </ng-template>
                          <ng-template pTemplate="output">
                              {{_Registro.Cuenta}}
                          </ng-template>
                      </p-cellEditor>
                    </td>
                    <td class="border-bottom-1 border-200">
                      <p-cellEditor>
                          <ng-template pTemplate="input">
                              <input  pInputText type="text" [(ngModel)]="_Registro.Valor" required>
                          </ng-template>
                          <ng-template pTemplate="output">
                              {{_Registro.Valor}}
                          </ng-template>
                      </p-cellEditor>
                    </td>
                    <td class="border-bottom-1 border-200">
                        <p-cellEditor class="min-w-full">
                            <ng-template pTemplate="input" [(ngModel)] = "_Registro.FechaRegistro">
                                <div style="min-width: 9rem;">
                                    <p-calendar [touchUI]="true" ></p-calendar>

                                </div>
                            </ng-template>
                            
                       
                            <ng-template pTemplate="output">
                                {{_Registro.FechaRegistro }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td class="border-bottom-1 border-200">
                        <p-cellEditor>
                            <ng-template  pTemplate="input">
                                <p-dropdown
                                 [options]="SociosNegocios" name="ItemSeleccionados"
                                appendTo="body" [(ngModel)]="_Registro.idSocioNegocio" [filter]="true" [showClear]="false" optionLabel="Nombre"
                                filterBy="Nombre" [style]="{'width':'100%'}"
                                placeholder="Socio de negocio">
                                <ng-template   pTemplate="selectedItem" let-selectedItem>
                                    {{selectedItem.Nombre}}
                                </ng-template>
                            </p-dropdown>
                             </ng-template>
                            <ng-template   pTemplate="output">
                                    {{_Registro.idSocioNegocio.Nombre }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <td class="border-bottom-1 border-200">
                      <div class="flex align-items-center justify-content-center gap-2">
                            <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow icon="pi pi-pencil" (click)="onRowEditInit(_Registro)" class="p-button-rounded p-button-text"></button>
                            <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow  (click)="onRowEditSave(_Registro)" class="p-button-rounded p-button-text p-button-success mr-2"><i class="pi pi-spin pi-spinner" style="font-size: 1.5rem"></i></button>
                            <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow icon="pi pi-times" (click)="onRowEditCancel(_Registro, ri)" class="p-button-rounded p-button-text p-button-danger"></button>
                        </div> 
                    </td>
                </tr>
            </ng-template>
        </p-table>
      </div>
 -->
